#+TITLE: Tramp ä½¿ç”¨æŒ‡å—
#+DATE: 2022-03-27T10:33:10+0800
#+LASTMOD: 2022-03-27T13:09:19+0800
#+TAGS[]: tramp project

[[https://www.gnu.org/software/tramp/][Tramp]] æ˜¯ Emacs ä¸­ç”¨æ¥ç¼–è¾‘è¿œç«¯æ–‡ä»¶çš„æ¨¡å—ï¼Œå…¨ç§°ä¸ºã€Transparent Remote (file) Access, Multiple Protocolã€ï¼Œç±»ä¼¼ä¸ VSCode çš„ [[https://code.visualstudio.com/docs/remote/remote-overview][Remote Development]]ï¼Œåªä¸è¿‡æ¯”å®ƒå¹´é•¿ 20 å²è€Œå·²ğŸ˜„ã€‚
è¿™è¾¹æ–‡ç« å°±æ¥ä»‹ç»ä¸‹ tramp çš„ä½¿ç”¨æ–¹å¼ä¸æ³¨æ„äº‹é¡¹ã€‚

* ä½¿ç”¨æ–¹å¼
åœ¨ä½¿ç”¨ =find-file= æ‰“å¼€æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨[[https://www.gnu.org/software/tramp/#File-name-syntax][ä¸‹é¢çš„è¯­æ³•]]ï¼Œå³å¯æ‰“å¼€è¿œç«¯çš„æ–‡ä»¶ï¼š
#+BEGIN_SRC emacs-lisp
/method:user@host:path/to/file
#+END_SRC
æ¯”å¦‚ï¼Œ =/ssh:vagrant@192.168.31.92:/etc/hosts= å³å¯ä»¥ vagrant ç”¨æˆ·ä½¿ç”¨ ssh åè®®ç™»å½• 192.168.31.92 æœºå™¨ï¼Œå¹¶ä¸”æ‰“å¼€ =/etc/hosts= æ–‡ä»¶ã€‚

å€ŸåŠ©äº ssh çš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„é…ç½®æ¥ç®€åŒ–æ‰“å¼€æ–‡ä»¶çš„å‘½ä»¤ï¼š
#+begin_src bash
# ~/.ssh/config
Host devhost
  HostName 192.168.31.92
  User vagrant
  IdentityFile ~/Documents/configs/vagrant-pk
  ControlMaster auto
  ControlPath ~/.ssh/master-%C
  ControlPersist 1h
#+end_src
è¿™æ ·åªéœ€è¾“å…¥ =/ssh:devhost:/etc/hosts= å³å¯ã€‚é€šè¿‡é…ç½® tramp é»˜è®¤åè®®ä¸º sshï¼Œå¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ä¸ºï¼š =/-:devhost:/etc/hosts=
#+BEGIN_SRC emacs-lisp
(setq tramp-default-method "ssh")
#+END_SRC
å¦å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½® directory-abbrev-alist ç®€åŒ–ï¼š
#+BEGIN_SRC emacs-lisp
(setq directory-abbrev-alist '(("^/dev" . "/-:dev:/etc")))
#+END_SRC
ç„¶åå† find-file æ‰“å¼€ =/dev= æ—¶ï¼Œè¾“å…¥ TABï¼Œä¼šè‡ªåŠ¨æ‰“å¼€ =/-:dev:/etc=
* [[https://www.gnu.org/software/tramp/#Remote-processes][ä¸å…¶ä»–æ¨¡å—ç»“åˆ]]
åœ¨ Emacs ä¸­ï¼Œshell.elã€eshell.elã€compile.elã€gud.elï¼ˆgdbï¼‰è¿™å‡ ä¸ªå†…ç½®æ¨¡å—éƒ½ä¸ tramp åšäº†å®Œç¾æ•´åˆï¼Œæ‰§è¡Œç›¸åº”å‘½ä»¤æ—¶ä¼šé€šè¿‡ç›¸åº”åè®®åœ¨è¿œç«¯æ‰§è¡Œã€‚
* å¤šçº§è·³è·ƒ multiple hops
ä¸€èˆ¬æ¥è¯´ï¼Œå…¬å¸å†…å¤„äºå®‰å…¨è€ƒè™‘ï¼Œä¼šç¦æ­¢å¼€å‘åŒå­¦ç›´æ¥ç™»å½•ç”Ÿäº§æœºå™¨ï¼Œç›¸åº”ä¼šæä¾›ä¸€è·³æ¿æœºæ¥ç™»å½•ç”Ÿäº§æœºå™¨
ï¼Œè¿™æ—¶å°±éœ€è¦å¤šæ¬¡è·³è·ƒã€‚tramp æ”¯æŒé€šè¿‡ä¸‹é¢çš„è¯­æ³•ï¼Œçº§è”ç™»å½•å¤šä¸ªæœºå™¨
#+begin_src bash
C-x C-f /ssh:bird@bastion|ssh:admin@production:/path RET
#+end_src
ä¸Šé¢å‘½ä»¤ä¼šå…ˆç”¨ bird ç”¨æˆ·ç™»å½•å ¡å’æœº bastionï¼Œä¹‹åå†åœ¨å ¡å’æœºä¸Šä»¥ admin ç”¨æˆ·ç™»å½• production æ‰“å¼€ =/path= ã€‚
* ä»¥ sudo æ–¹å¼æ‰“å¼€æ–‡ä»¶
ä¸€èˆ¬æ¥è¯´ï¼Œç™»å½•è¿œç«¯æœºå™¨æ—¶éƒ½æ˜¯é root ç”¨æˆ·ï¼Œæœ‰æ—¶ä¼šéœ€è¦ç”¨ sudo æ¥æ‰“å¼€æŸäº›æ–‡ä»¶ï¼Œtramp é€šè¿‡ä¸‹é¢çš„è¯­æ³•æ”¯æŒè¿™ç±»æ“ä½œï¼š
#+begin_src bash
C-x C-f /ssh:you@remotehost|sudo::/path RET
#+end_src
=sudo::= çš„æ–¹å¼åœ¨ Emacs 27 ä¸Š[[https://stackoverflow.com/a/16408592/2163429][è¿è¡Œæ²¡æœ‰é—®é¢˜]]ï¼Œå…¶ä»–ä½ç‰ˆæœ¬å¯èƒ½éœ€è¦è¾“å…¥å®Œæ•´çš„å‘½ä»¤ï¼š
#+begin_src bash
C-x C-f /ssh:you@remotehost|sudo:remotehost:/path RET
#+end_src
* æ³¨æ„äº‹é¡¹
Tramp æ‰“å¼€çš„è¿œç«¯æ–‡ä»¶å’Œæœ¬åœ°çš„æ–‡ä»¶æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä¼šè¢«è®°å½•åœ¨ backupã€autosaveã€recentf ç­‰ä¸­ã€‚åœ¨ä»Šåé‡å¯ Emacs æ—¶ï¼Œå¦‚æœè¿™æ—¶æ— æ³•è¿æ¥è¿œç«¯æœºå™¨ï¼ŒEmacs å¯èƒ½ä¼šå¡ä½ï¼Œè¿™æ—¶å› ä¸º tramp ä¼šå¯¹ä¹‹å‰æ‰“å¼€çš„æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¯ä»¥é€šè¿‡[[https://stackoverflow.com/a/22077775/2163429][ä¸‹é¢çš„ä¸€äº›é…ç½®]]æ¥ç»•è¿‡ trampï¼Œè®© backup ç­‰æœºåˆ¶ä¸å¯¹ tramp æ‰“å¼€çš„æ–‡ä»¶èµ·ä½œç”¨ï¼š
#+BEGIN_SRC emacs-lisp
(setq recentf-exclude `(,tramp-file-name-regexp
                        "COMMIT_EDITMSG")
      tramp-auto-save-directory temporary-file-directory
      backup-directory-alist (list (cons tramp-file-name-regexp nil)))
#+END_SRC
å¦‚æœç”¨äº† [[https://github.com/emacs-dashboard/emacs-dashboard][emacs-dashboard]] æ¥å±•ç¤º project.el ä¸­çš„é¡¹ç›®ï¼ŒEmacs å¯åŠ¨æ—¶ä¼šæ£€æŸ¥è¿™äº›é¡¹ç›®ï¼Œå› æ­¤ä¹Ÿéœ€è¦è·³è¿‡é‚£äº›è¿œç«¯é¡¹ç›®ï¼Œä¸è¦æŒä¹…åŒ–ä¿å­˜ï¼š
#+BEGIN_SRC emacs-lisp
(defun my/project-remember-advice (fn pr &optional no-write)
  (let* ((remote? (file-remote-p (project-root pr)))
         (no-write (if remote? t no-write)))
    (funcall fn pr no-write)))

(advice-add 'project-remember-project :around
            'my/project-remember-advice)
#+END_SRC

å¦‚æœé€šè¿‡ä¸Šé¢çš„é…ç½®ï¼Œæ‰“å¼€ Emacs è¿˜æ˜¯æœ‰å¡å¨ï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´ tramp-verbose æ¥è¿›è¡Œè°ƒè¯•ï¼š
#+BEGIN_SRC emacs-lisp
(setq tramp-verbose 10); é»˜è®¤æ˜¯ 3
#+END_SRC
è®¾ç½®ä¹‹åå†é‡å¯æ—¶ï¼Œä¼šåœ¨ =*debug-tramp*= å†…æ‰“å¼€å‡º tramp æ‰§è¡Œçš„è¯¦ç»†ä¿¡æ¯ã€‚ä¸‹å›¾ä¸ºç¬”è€…è°ƒè¯•å›  project.el å¡ä½æ—¶çš„æˆªå›¾ï¼š
#+CAPTION: *debug-tramp* ç¤ºæ„å›¾
https://img.alicdn.com/imgextra/i2/581166664/O1CN011TDwOt1z6A7zQEy7u_!!581166664.png
* æ›´å¤šå®è·µ
- [[https://willschenk.com/articles/2020/tramp_tricks/][Emacs Tramp tricks -- Editing a file inside of a docker container]]
- [[https://www.gnu.org/software/tramp/#Frequently-Asked-Questions][TRAMP 2.5.2 User Manual -- Frequently Asked Questions]]
