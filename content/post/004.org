#+TITLE: 优化配置启动时间
#+DATE: 2021-08-22T12:49:15+08:00
#+DRAFT: true
#+TAGS[]: tips

最近在知乎上回答了一个问题[[https://www.zhihu.com/question/472788138/answer/2006637253][请问你的emacs启动需要多久？]]，之前一直怎么花经历去优化启动时间，虽然知道一些理论，但纸上得来终觉浅，于是这个周末实践了一下，这篇文章就来总结下收获。

* 目标
Emacs 中提供了一个函数来记录启动时长，即 =emacs-init-time= ，后文也用这个时间作为优化目标。
首先看下零配置下的时间，这个值也是理论上的最优值

#+BEGIN_SRC
emacs -Q -nw

M-x emacs-init-time
0.005363 seconds
#+END_SRC

* 效果
介绍具体步骤前，先看看这次优化的数据
- 优化前：130 个包，7.681082 seconds
- 优化后：60 个包，0.97 seconds
* 工具
* 过程
** 去掉 org-babel
在很久之前，得知可以把配置写在一个
纸上得来终倔起按
#+begin_src emacs-lisp
(defmacro my/timer (&rest body)
  "Measure and return the time it takes evaluating BODY."
  `(let ((time (current-time)))
     ,@body
     (float-time (time-since time))))

(message "projectile config cost %s"
         (my/timer
          (use-package projectile
            :init
            (projectile-mode +1)
            :bind ("C-c p" . projectile-command-map)
            :custom (projectile-project-search-path '("~/code/" "~/gh/" "~/code/antfin/" "~/code/misc"))
            :config
            (setq projectile-switch-project-action #'projectile-find-file-dwim
                  projectile-completion-system 'ivy
                  ;; projectile-enable-caching t
                  projectile-project-root-functions '(projectile-root-local
                                                      projectile-root-bottom-up)
                  projectile-project-root-files-bottom-up '(".projectile" "README.org" "README.md"
                                                            "Makefile" "pom.xml" "go.mod" "cargo.toml" "project.clj"
                                                            ".git" ".hg")
                  projectile-ignored-project-function (lambda (project-root)
                                                        (cl-dolist (deny '("\\.git" "\\.rustup" "\\.cargo" "go/pkg" "vendor"))
                                                          (when (string-match-p deny project-root)
                                                            (cl-return t))))))))

#+end_src

projectile config cost 0.781213


67 packages loaded in 2.214488 seconds
3.681204 seconds

#+BEGIN_SRC bash
  ├─[~/.config/emacs/i-edit.el load 573ms]
  │ ├─[smex require 6ms]
  │ │ ╰─[ido require 16ms]
  │ ├─[ivy-faces require 6ms]
  │ ├─[ivy-overlay require 6ms]
  │ ├─[colir require 6ms]
  │ │ ╰─[color require 12ms]
  │ ├─[smartparens-config require 12ms]
  │ │ ├─[smartparens-text require 9ms]
  │ │ ╰─[smartparens require 59ms]
  │ │   ╰─[dash require 36ms]
  │ ├─[persistent-scratch require 5ms]
  │ ├─[diff require 12ms]
  │ ├─[filenotify require 13ms]
  │ ├─[~/.config/emacs/var/recentf-save.el load 2ms]
  │ ├─[tree-widget require 12ms]
  │ ├─[cus-start require 14ms]
  │ ├─[cus-load require 20ms]
  │ ╰─[wid-edit require 18ms]
  ├─[~/.config/emacs/i-basic.el load 63ms]
#+END_SRC
-*- mode:grep; default-directory: "~/.config/emacs/" -*-


5 candidates:
./*Benchmark Init Results Tabulated*:1:  ~/.config/emacs/i-edit.el                                         load        266     467
./*Benchmark Init Results Tabulated*:2:  ~/.config/emacs/i-basic.el                                        load         79     603
./*Benchmark Init Results Tabulated*:9:  ~/.config/emacs/i-ui.el                                           load         26      61
./*Benchmark Init Results Tabulated*:26:  ~/.config/emacs/i-prog.el                                         load         14      61
./*Benchmark Init Results Tabulated*:62:  ~/.config/emacs/i-misc.el                                         load         10      25


* 参考
https://blog.d46.us/advanced-emacs-startup/
